<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Coder Prototype</title>
    <style>
        body { 
            font-family: sans-serif; 
            padding: 20px; 
            max-width: 900px;
            margin: 0 auto;
        }
        
        label { 
            display: block; 
            margin-top: 10px; 
        }
        
        input[type="text"], input[type="number"] { 
            width: 300px; 
            padding: 8px; 
            margin-top: 5px; 
        }
        
        button { 
            padding: 10px 15px; 
            margin-top: 15px; 
            cursor: pointer; 
            background-color: #4CAF50;
            border: none;
            color: white;
            border-radius: 4px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        #result-area { 
            margin-top: 20px; 
        }
        
        #qr-code img { 
            border: 1px solid #ccc; 
            display: block; 
            margin-bottom: 10px; 
            max-width: 200px;
        }
        
        #app-url { 
            margin-top: 5px; 
            word-wrap: break-word; 
        }
        
        #status { 
            margin-top: 15px; 
            font-style: italic; 
            color: #555; 
        }
        
        .toggle-container {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .payment-mode-container {
            background-color: #f0f8ff;
            border: 1px solid #2196F3;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .email-status {
            display: inline-block;
            margin-left: 15px;
            font-weight: bold;
        }
        
        /* Receipt styling */
        .receipt-paper {
            background-color: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-family: 'Courier New', monospace;
            max-width: 300px;
            margin: 20px auto;
            padding: 20px;
            position: relative;
        }
        
        .receipt-paper::before {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(45deg, #fff 25%, transparent 25%),
                        linear-gradient(-45deg, #fff 25%, transparent 25%);
            background-size: 10px 10px;
        }
        
        .receipt-header {
            text-align: center;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .receipt-footer {
            text-align: center;
            border-top: 1px dashed #000;
            margin-top: 15px;
            padding-top: 10px;
            font-size: 12px;
        }
        
        .payment-log {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f0fff0;
            display: none;
        }
        
        /* Dot matrix printer effects */
        @keyframes printing {
            from { 
                height: 0; 
                opacity: 0.7;
            }
            to { 
                height: 100%; 
                opacity: 1;
            }
        }
        
        @keyframes printer-sound {
            0%, 100% { transform: translateY(0); }
            10% { transform: translateY(-1px); }
            20% { transform: translateY(1px); }
            30% { transform: translateY(-1px); }
            40% { transform: translateY(1px); }
            50% { transform: translateY(0); }
        }
        
        .printing {
            animation: printing 2s linear, printer-sound 0.5s steps(10) 4;
            overflow: hidden;
            position: relative;
        }
        
        /* Printer line scanning effect */
        .printing::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background-color: rgba(0, 0, 255, 0.2);
            animation: scan-line 2s linear;
            animation-fill-mode: forwards;
            z-index: 100;
        }
        
        @keyframes scan-line {
            from { top: 0; }
            to { top: 100%; }
        }
        
        .log-area {
            height: 120px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f5f5f5;
            font-family: monospace;
            font-size: 12px;
        }
        
        .tabs {
            display: flex;
            margin-top: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
            border: 1px solid #ddd;
            border-bottom: none;
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        .tab-content {
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>Vibe Coder Prototype</h1>
    
    <div class="tabs">
        <div class="tab active" data-tab="manual">Manual Generation</div>
        <div class="tab" data-tab="venmo">Payment Monitor</div>
    </div>
    
    <div id="manual-tab" class="tab-content active">
        <p>Simulate a payment to generate a custom web app using Gemini and push it to GitHub.</p>
        
        <form id="payment-form">
            <label for="app_type">What app do you need?</label>
            <input type="text" id="app_type" name="app_type" placeholder="e.g., Simple Calculator, Basic Timer, Coffee Shop Landing Page" required>
    
            <label for="amount">Simulated Payment Amount (USD):</label>
            <input type="number" id="amount" name="amount" min="0.25" step="0.25" placeholder="e.g., 0.25 (Low Tier) or 2.00 (High Tier)" required>
    
            <button type="submit">Generate App</button>
        </form>
    
        <div id="status"></div>
        <div id="result-area">
            <div id="qr-code"></div>
            <div id="app-url"></div>
        </div>
    </div>
    
    <div id="venmo-tab" class="tab-content">
        <h2 style="text-align: center;">App Design as a Commodity</h2>
        
        <div class="payment-mode-container">
            <div>
                <strong>Payment Mode:</strong>
                <span id="payment-mode-label">Venmo</span>
            </div>
            <div style="display: flex; align-items: center;">
                <span style="margin-right: 10px;">VibePay</span>
                <label class="toggle-switch" for="payment-mode-toggle">
                    <input type="checkbox" id="payment-mode-toggle" checked>
                    <span class="slider"></span>
                </label>
                <span style="margin-left: 10px;">Venmo</span>
            </div>
        </div>
        
        <div class="receipt-paper" id="instructions-receipt">
            <div class="receipt-header">
                <h3>VIBE CODER</h3>
                <p>Interactive Art Installation</p>
                <p id="receipt-date"></p>
            </div>
            
            <div class="receipt-item">
                <span>ITEM:</span>
                <span>CUSTOM APP DEVELOPMENT</span>
            </div>
            
            <div class="receipt-body" style="margin: 15px 0;">
                <p>In the <span data-payment-service>Venmo</span> description, describe the app you want to have:</p>
                <ul style="list-style-type: none; padding-left: 10px;">
                    <li>- Pay $0.25 for a quick app</li>
                    <li>- Pay $1.00 for a high quality app</li>
                </ul>
                <p>Your app will be automatically generated after payment is detected.</p>
            </div>
            
            <div id="venmo-qr-container" style="text-align: center; margin: 15px 0;"></div>
            
            <div class="receipt-footer">
                <p>Scan to pay via <span data-payment-service>Venmo</span></p>
                <p>Thank you for participating</p>
                <p>www.haukesand.github.io</p>
            </div>
        </div>
        
        <!-- Email monitoring will be enabled automatically -->
        
        <!-- Payment Receipt (displays when payment is detected) -->
        <div class="receipt-paper printing" id="payment-receipt" style="display: none;">
            <div class="receipt-header">
                <h3>PAYMENT RECEIVED</h3>
                <p id="payment-timestamp"></p>
            </div>
            
            <div id="payment-details-receipt">
                <!-- Payment details will be inserted here -->
            </div>
            
            <div class="receipt-footer">
                <p>Generating Your Custom App...</p>
                <p style="font-size: 10px;">Please wait while we create your app</p>
            </div>
        </div>
        
        <div class="receipt-paper" style="margin-top: 30px;">
            <div class="receipt-header">
                <h3>SYSTEM LOGS</h3>
                <p>Payment Monitor Status</p>
            </div>
            
            <div class="log-area" id="email-log" style="height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 11px; text-align: left; border: none; background: transparent; max-width: initial; margin: 0; padding: 5px;">
                <!-- Email monitoring logs will be displayed here -->
            </div>
            
            <div class="receipt-footer">
                <p>Payment monitoring is automatic</p>
            </div>
        </div>
    </div>

    <script>
        // Payment mode toggle functionality
        const paymentModeToggle = document.getElementById('payment-mode-toggle');
        const paymentModeLabel = document.getElementById('payment-mode-label');
        
        // Initialize the payment mode based on server state
        async function initPaymentMode() {
            try {
                const response = await fetch("/api/email-status");
                const result = await response.json();
                
                if (response.ok && result.payment_mode) {
                    // Set the toggle state based on the current mode
                    const isVenmo = result.payment_mode === "venmo";
                    paymentModeToggle.checked = isVenmo;
                    paymentModeLabel.textContent = isVenmo ? "Venmo" : "VibePay";
                    
                    // Add the initial log
                    addLog(`Current payment mode: ${isVenmo ? "Venmo" : "VibePay"}`);
                }
            } catch (error) {
                console.error("Error getting payment mode:", error);
            }
        }
        
        // Handle payment mode toggle changes
        paymentModeToggle.addEventListener('change', async function() {
            const isVenmo = this.checked;
            const newMode = isVenmo ? "venmo" : "vibepay";
            
            try {
                // Update the label immediately for responsive UI
                paymentModeLabel.textContent = isVenmo ? "Venmo" : "VibePay";
                
                // Send the request to update the mode
                const response = await fetch("/api/toggle-payment-mode", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ mode: newMode })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || "Failed to update payment mode");
                }
                
                // Update the UI with the new mode
                addLog(`Payment mode switched to ${isVenmo ? "Venmo" : "VibePay"}`);
                
                // Force a refresh of the QR code display
                setTimeout(() => {
                    // Get updated status with fresh QR codes
                    fetch("/api/email-status")
                        .then(response => response.json())
                        .then(result => {
                            if (response.ok) {
                                // Update the QR code display with the new payment mode
                                updatePaymentQRCode(result);
                            }
                        })
                        .catch(error => console.error("Error refreshing QR code:", error));
                }, 1000); // Small delay to ensure the server has time to update
                
            } catch (error) {
                addLog(`Error switching payment mode: ${error.message}`, 'error');
                console.error("Error:", error);
                
                // Revert the toggle if there was an error
                this.checked = !this.checked;
                paymentModeLabel.textContent = this.checked ? "Venmo" : "VibePay";
            }
        });
        
        // Simple auto-check for updates every second
        setInterval(function() {
            // If we're on the Venmo tab, check for app updates
            const venmoTab = document.querySelector('.tab[data-tab="venmo"]');
            if (venmoTab && venmoTab.classList.contains('active')) {
                // Keep email monitoring active
                startEmailMonitoring();
                
                // Check for status updates (this will refresh the UI if there's a new app)
                checkEmailStatus();
            }
        }, 1000); // Check every second for a smooth, real-time feeling
        
        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and contents
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                const tabName = tab.getAttribute('data-tab');
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                // Auto-start email monitoring when switching to the Venmo tab
                if (tabName === 'venmo') {
                    // Start email monitoring if not already active
                    startEmailMonitoring();
                }
            });
        });
        
        // Function to ensure email monitoring is enabled
        async function startEmailMonitoring() {
            try {
                // First check the current status
                const response = await fetch("/api/email-status");
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error("Failed to get email status.");
                }
                
                const isActive = result.email_monitoring;
                
                // Only need to enable if not already active
                if (!isActive) {
                    addLog("Starting email monitoring automatically...");
                    
                    const response = await fetch("/api/email-monitor", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ enabled: true }),
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.error || "Failed to start email monitoring.");
                    }
                    
                    addLog("Email monitoring started automatically");
                    
                    // Start checking for status updates
                    startStatusUpdates();
                }
                
            } catch (error) {
                addLog(`Error starting email monitoring: ${error.message}`, 'error');
                console.error("Error:", error);
            }
        }
        
        // Manual app generation form
        const form = document.getElementById("payment-form");
        const statusDiv = document.getElementById("status");
        const qrCodeDiv = document.getElementById("qr-code");
        const appUrlDiv = document.getElementById("app-url");

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            statusDiv.textContent = "Generating app via LLM and pushing to GitHub... Please wait (this may take a minute).";
            qrCodeDiv.innerHTML = ""; // Clear previous QR code
            appUrlDiv.innerHTML = ""; // Clear previous URL

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch("/generate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json(); // Always try to parse JSON

                // Handle cooldown/lock responses (HTTP 429)
                if (response.status === 429) {
                    const cooldownMsg = document.createElement("div");
                    cooldownMsg.style.backgroundColor = "#fff3cd";
                    cooldownMsg.style.color = "#856404";
                    cooldownMsg.style.padding = "10px";
                    cooldownMsg.style.borderRadius = "5px";
                    cooldownMsg.style.marginTop = "15px";
                    cooldownMsg.style.marginBottom = "15px";
                    cooldownMsg.style.border = "1px solid #ffeeba";
                    
                    if (result.is_generating) {
                        cooldownMsg.innerHTML = `<strong>Another app is currently being generated.</strong><br>Please wait until the current generation completes.`;
                    } else {
                        const remainingTime = Math.ceil(result.cooldown_seconds_remaining || 0);
                        cooldownMsg.innerHTML = `<strong>Generation cooldown in effect.</strong><br>Please wait ${remainingTime} more seconds before generating another app.`;
                    }
                    
                    statusDiv.innerHTML = "";
                    statusDiv.appendChild(cooldownMsg);
                    
                    // Start a countdown timer if we have remaining time
                    if (result.cooldown_seconds_remaining && !result.is_generating) {
                        const remainingTime = Math.ceil(result.cooldown_seconds_remaining);
                        let timeLeft = remainingTime;
                        
                        const timerSpan = document.createElement("span");
                        timerSpan.textContent = `${timeLeft}`;
                        cooldownMsg.innerHTML = `<strong>Generation cooldown in effect.</strong><br>Please wait <span id="cooldown-timer">${timeLeft}</span> more seconds before generating another app.`;
                        
                        const timer = setInterval(() => {
                            timeLeft--;
                            document.getElementById("cooldown-timer").textContent = timeLeft;
                            
                            if (timeLeft <= 0) {
                                clearInterval(timer);
                                statusDiv.textContent = "Ready to generate a new app.";
                            }
                        }, 1000);
                    }
                    
                    return; // Exit early for cooldown/lock errors
                }

                if (!response.ok) {
                    throw new Error(result.error || `App generation failed with status ${response.status}.`);
                }

                statusDiv.textContent = `${result.message} GitHub: ${result.github_url}`; 

                // Display QR code
                if (result.qr_code_image) {
                   const img = document.createElement("img");
                   img.src = `data:image/png;base64,${result.qr_code_image}`;
                   img.alt = "QR Code for Generated App";
                   qrCodeDiv.appendChild(img);
                } else {
                    qrCodeDiv.textContent = "(QR code image not available)";
                }

                // Display Full URL
                if (result.hosted_url_full) {
                    const urlLink = document.createElement("a");
                    urlLink.href = result.hosted_url_full; // Use full URL for link
                    urlLink.textContent = result.hosted_url_full;
                    urlLink.target = "_blank"; // Open in new tab
                    appUrlDiv.appendChild(document.createTextNode("Access URL: "));
                    appUrlDiv.appendChild(urlLink);
                } else {
                    appUrlDiv.textContent = "(App URL not available)";
                }
                
                // Create a receipt for the manual generation too
                // Switch to Venmo tab
                setTimeout(() => {
                    tabs[1].click();
                    
                    // Create the receipt element if it doesn't exist
                    const generatedReceiptExists = document.getElementById('generated-app-receipt');
                    if (!generatedReceiptExists) {
                        // Create the receipt element
                        const generatedReceipt = document.createElement('div');
                        generatedReceipt.id = 'generated-app-receipt';
                        generatedReceipt.className = 'receipt-paper printing';
                        generatedReceipt.style.marginTop = '20px';
                        
                        // Structure the receipt content
                        generatedReceipt.innerHTML = `
                            <div class="receipt-header">
                                <h3>APP GENERATED!</h3>
                                <p>Thank you for your order</p>
                                <p>${new Date().toLocaleString()}</p>
                            </div>
                            
                            <div class="receipt-item">
                                <span>APP TYPE:</span>
                                <span style="max-width: 170px; overflow-wrap: break-word;">${result.app_type_received}</span>
                            </div>
                            
                            <div class="receipt-item">
                                <span>TIER:</span>
                                <span>${result.amount_received >= 1.00 ? 'HIGH QUALITY' : 'QUICK APP'}</span>
                            </div>
                            
                            <div style="text-align: center; margin: 15px 0;">
                                <div id="manual-generated-app-qr"></div>
                                <p style="margin-top: 10px; font-size: 12px;">Scan to view your app</p>
                            </div>
                            
                            <div class="receipt-item">
                                <span>GITHUB:</span>
                                <span style="font-size: 12px; max-width: 170px; overflow-wrap: break-word; word-break: break-all;">${result.github_url}</span>
                            </div>
                            
                            <div class="receipt-item" style="background-color: #e6f7ff; padding: 5px; border-radius: 4px; margin: 8px 0;">
                                <span style="font-weight: bold;">URL:</span>
                                <span style="font-size: 12px; max-width: 170px; overflow-wrap: break-word; word-break: break-all; font-weight: bold;">${result.hosted_url_full}</span>
                            </div>
                            
                            <div style="margin-top: 15px; word-break: break-all; text-align: center;">
                                <div><a href="${result.github_url}" target="_blank" style="color: #0066cc; text-decoration: underline; font-weight: bold; font-size: 14px; background-color: #f0f0f0; padding: 5px; border-radius: 4px; display: inline-block;">VIEW SOURCE CODE</a></div>
                                <div style="margin-top: 10px;"><a href="${result.hosted_url_full}" target="_blank" style="color: #0066cc; text-decoration: underline; font-weight: bold; font-size: 16px; background-color: #e6f7ff; padding: 8px; border-radius: 4px; border: 1px solid #0066cc; display: inline-block;">OPEN GENERATED APP</a></div>
                            </div>
                            
                            <div class="dev-logs" style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; font-family: monospace; font-size: 10px; text-align: left; max-height: 150px; overflow-y: auto;">
                                <p style="margin: 0; padding: 0; font-weight: bold;">Development Logs:</p>
                                <div id="manual-app-logs" style="white-space: pre-wrap; word-break: break-word; color: #333;"></div>
                            </div>
                            
                            <div class="receipt-footer">
                                <p>Made with ♥ by Vibe Coder</p>
                                <p>App Design as a Commodity</p>
                                <p>Interactive Art Installation</p>
                            </div>
                        `;
                        
                        // Append the receipt at the bottom after the log area
                        const venmoTab = document.getElementById('venmo-tab');
                        venmoTab.appendChild(generatedReceipt);
                        
                        // Add the QR code to the receipt
                        if (result.qr_code_image) {
                            const qrDiv = document.getElementById('manual-generated-app-qr');
                            const img = document.createElement("img");
                            img.src = `data:image/png;base64,${result.qr_code_image}`;
                            img.alt = "QR Code for Generated App";
                            img.style.maxWidth = "150px";
                            img.style.margin = "0 auto";
                            img.style.display = "block";
                            qrDiv.appendChild(img);
                            
                            // Add the development logs if available
                            if (result.logs) {
                                const logElement = document.getElementById('manual-app-logs');
                                if (logElement) {
                                    logElement.textContent = result.logs;
                                }
                            }
                        }
                        
                        // Play a printer sound effect if available
                        try {
                            const audio = new Audio('/static/printer.mp3');
                            audio.play().catch(e => console.log('Sound not available'));
                        } catch (e) {
                            // Sound not critical, just continue silently
                        }
                        
                        // Scroll to the bottom to ensure the receipt is visible
                        venmoTab.scrollTop = venmoTab.scrollHeight;
                    }
                }, 500);

            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                console.error("Error:", error);
            }
        });
        
        // Email monitoring functionality
        const emailLog = document.getElementById("email-log");
        
        let lastPayment = null;
        
        // Initialize receipt date
        document.getElementById("receipt-date").textContent = new Date().toLocaleDateString();
        
        // Check initial status on page load
        checkEmailStatus();
        
        // Function to update the payment QR code display
        function updatePaymentQRCode(result) {
            const qrContainer = document.getElementById("venmo-qr-container");
            const currentMode = result.payment_mode || "venmo";
            
            // Clear the container
            qrContainer.innerHTML = "";
            
            // Determine which QR code and URL to use
            let qrCodeBase64, profileUrl, serviceName;
            
            if (currentMode === "venmo") {
                qrCodeBase64 = result.venmo_qr_code;
                profileUrl = result.venmo_profile_url;
                serviceName = "Venmo";
            } else {
                qrCodeBase64 = result.vibepay_qr_code;
                profileUrl = result.vibepay_url;
                serviceName = "VibePay";
            }
            
            // Log what we have for debugging
            console.log(`Updating QR code for ${serviceName}:`, { 
                qrCodeBase64: qrCodeBase64 ? `${qrCodeBase64.substring(0, 20)}...` : 'missing',
                profileUrl: profileUrl || 'missing'
            });
            
            // Update the QR code image
            if (qrCodeBase64) {
                const img = document.createElement("img");
                img.src = `data:image/png;base64,${qrCodeBase64}`;
                img.alt = `${serviceName} QR Code`;
                img.style.maxWidth = "200px";
                img.style.border = "1px solid #ccc";
                qrContainer.appendChild(img);
                
                // Add a link below the QR code that also notifies our server
                const link = document.createElement("div");
                link.innerHTML = `<a href="${profileUrl}" target="_blank" onclick="notifyQRScanned(event)">Or click here to open ${serviceName}</a>`;
                link.style.marginTop = "10px";
                link.style.fontSize = "12px";
                qrContainer.appendChild(link);
                
                // Make the QR code image also trigger the notification
                img.onclick = notifyQRScanned;
            } else {
                // If no QR code, generate a message and regenerate
                const errorMsg = document.createElement("div");
                errorMsg.innerText = `QR code for ${serviceName} not found. Regenerating...`;
                errorMsg.style.color = "#f44336";
                errorMsg.style.padding = "10px";
                errorMsg.style.border = "1px solid #f44336";
                errorMsg.style.borderRadius = "4px";
                errorMsg.style.marginBottom = "10px";
                qrContainer.appendChild(errorMsg);
                
                // Create a placeholder for the missing QR
                const placeholderQR = document.createElement("div");
                placeholderQR.style.width = "200px";
                placeholderQR.style.height = "200px";
                placeholderQR.style.border = "1px dashed #ccc";
                placeholderQR.style.display = "flex";
                placeholderQR.style.alignItems = "center";
                placeholderQR.style.justifyContent = "center";
                placeholderQR.style.margin = "0 auto";
                placeholderQR.innerText = "QR Loading...";
                qrContainer.appendChild(placeholderQR);
                
                // Try to refresh after a short delay
                setTimeout(() => {
                    fetch("/api/email-status")
                        .then(response => response.json())
                        .then(result => {
                            if (response.ok) {
                                // Update the QR code display with the new data
                                updatePaymentQRCode(result);
                            }
                        })
                        .catch(error => console.error("Error refreshing QR code:", error));
                }, 2000);
            }
            
            // Update any references to the payment service in the receipt
            document.querySelectorAll('[data-payment-service]').forEach(element => {
                element.textContent = serviceName;
            });
        }
        
        // Email monitoring is now started automatically when switching to the Venmo tab
        
        // App generation happens automatically when a payment is detected
        // No manual intervention is needed
        
        // Check current email monitoring status
        async function checkEmailStatus() {
            try {
                const response = await fetch("/api/email-status");
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error("Failed to get email status.");
                }
                
                const isActive = result.email_monitoring;
                
                // Update payment QR code display
                updatePaymentQRCode(result);
                
                if (isActive) {
                    const currentMode = result.payment_mode === "venmo" ? "Venmo" : "VibePay";
                    addLog(`Email monitoring active. ${currentMode} QR code ready for payments.`);
                }
                
                // Update last payment info if available
                if (result.last_payment) {
                    lastPayment = result.last_payment;
                    
                    // Show the payment receipt
                    const paymentReceipt = document.getElementById("payment-receipt");
                    paymentReceipt.style.display = "block";
                    paymentReceipt.classList.add("printing");
                    
                    // Auto-generate app if it's a new payment
                    if (!lastPayment || lastPayment.processed !== true) {
                        // Trigger app generation automatically
                        setTimeout(async () => {
                            try {
                                addLog(`Automatically generating app from payment: ${lastPayment.note} ($${lastPayment.amount})`);
                                
                                const response = await fetch("/generate", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        app_type: lastPayment.note,
                                        amount: lastPayment.amount
                                    }),
                                });
                                
                                const result = await response.json();
                                
                                if (!response.ok) {
                                    throw new Error(result.error || "App generation failed.");
                                }
                                
                                // Mark payment as processed
                                lastPayment.processed = true;
                                
                                // Display generation result
                                addLog(`App generated successfully! App ID: ${result.app_type_received}`);
                                
                            } catch (error) {
                                addLog(`Error generating app: ${error.message}`, 'error');
                                console.error("Error:", error);
                            }
                        }, 2000); // Short delay to show receipt first
                    }
                    
                    // Format timestamp for the receipt
                    const timestamp = new Date(lastPayment.timestamp * 1000);
                    document.getElementById("payment-timestamp").textContent = timestamp.toLocaleString();
                    
                    // Format the payment details in receipt format
                    const paymentDetailsReceipt = document.getElementById("payment-details-receipt");
                    paymentDetailsReceipt.innerHTML = `
                        <div class="receipt-item">
                            <span>FROM:</span>
                            <span>${lastPayment.sender || 'Anonymous'}</span>
                        </div>
                        <div class="receipt-item">
                            <span>AMOUNT:</span>
                            <span>$${lastPayment.amount.toFixed(2)}</span>
                        </div>
                        <div class="receipt-item">
                            <span>APP TYPE:</span>
                            <span style="max-width: 170px; overflow-wrap: break-word;">${lastPayment.note}</span>
                        </div>
                        <div class="receipt-item">
                            <span>TIER:</span>
                            <span>${lastPayment.amount >= 1.00 ? 'HIGH QUALITY' : 'QUICK APP'}</span>
                        </div>
                    `;
                    
                    addLog(`Payment received: $${lastPayment.amount} for "${lastPayment.note}"`);
                }
                
                // If we have a last generated app (from automatic processing), show it
                if (result.last_generated_app) {
                    const app = result.last_generated_app;
                    // Check if this is a recent app (generated in the last 60 seconds)
                    const isRecent = (Date.now() / 1000) - app.timestamp < 60;
                    
                    if (isRecent) {
                        // Create and display the final receipt with app details
                        const generatedReceiptExists = document.getElementById('generated-app-receipt');
                        if (!generatedReceiptExists) {
                            // Create the receipt element
                            const generatedReceipt = document.createElement('div');
                            generatedReceipt.id = 'generated-app-receipt';
                            generatedReceipt.className = 'receipt-paper printing';
                            generatedReceipt.style.marginTop = '20px';
                            
                            // Structure the receipt content
                            generatedReceipt.innerHTML = `
                                <div class="receipt-header">
                                    <h3>APP GENERATED!</h3>
                                    <p>Thank you for your order</p>
                                    <p>${new Date(app.timestamp * 1000).toLocaleString()}</p>
                                </div>
                                
                                <div class="receipt-item">
                                    <span>APP TYPE:</span>
                                    <span style="max-width: 170px; overflow-wrap: break-word;">${app.app_type}</span>
                                </div>
                                
                                <div class="receipt-item">
                                    <span>TIER:</span>
                                    <span>${app.tier}</span>
                                </div>
                                
                                <div style="text-align: center; margin: 15px 0;">
                                    <div id="generated-app-qr"></div>
                                    <p style="margin-top: 10px; font-size: 12px;">Scan to view your app</p>
                                </div>
                                
                                <div class="receipt-item">
                                    <span>GITHUB:</span>
                                    <span style="font-size: 12px; max-width: 170px; overflow-wrap: break-word; word-break: break-all;">${app.github_url}</span>
                                </div>
                                
                                <div class="receipt-item" style="background-color: #e6f7ff; padding: 5px; border-radius: 4px; margin: 8px 0;">
                                    <span style="font-weight: bold;">URL:</span>
                                    <span style="font-size: 12px; max-width: 170px; overflow-wrap: break-word; word-break: break-all; font-weight: bold;">${app.hosted_url_full}</span>
                                </div>
                                
                                <div style="margin-top: 15px; word-break: break-all; text-align: center;">
                                    <div><a href="${app.github_url}" target="_blank" style="color: #0066cc; text-decoration: underline; font-weight: bold; font-size: 14px; background-color: #f0f0f0; padding: 5px; border-radius: 4px; display: inline-block;">VIEW SOURCE CODE</a></div>
                                    <div style="margin-top: 10px;"><a href="${app.hosted_url_full}" target="_blank" style="color: #0066cc; text-decoration: underline; font-weight: bold; font-size: 16px; background-color: #e6f7ff; padding: 8px; border-radius: 4px; border: 1px solid #0066cc; display: inline-block;">OPEN GENERATED APP</a></div>
                                </div>
                                
                                <div class="receipt-item" style="justify-content: center; font-weight: bold; border-top: 1px dashed #000; margin-top: 10px; padding-top: 5px;">
                                    <span>SYSTEM INFORMATION</span>
                                </div>
                                
                                <div class="dev-logs" style="margin-top: 5px; font-family: monospace; font-size: 10px; text-align: left; max-height: 150px; overflow-y: auto;">
                                    <pre id="app-logs-${app.timestamp}" style="white-space: pre-wrap; word-break: break-word; color: #333; margin: 0; padding: 0; font-family: 'Courier New', monospace;"></pre>
                                </div>
                                
                                <div class="receipt-footer">
                                    <p>Made with ♥ by Vibe Coder</p>
                                    <p>App Design as a Commodity</p>
                                    <p>Interactive Art Installation</p>
                                </div>
                            `;
                            
                            // Append the receipt at the bottom after the log area
                            const venmoTab = document.getElementById('venmo-tab');
                            venmoTab.appendChild(generatedReceipt);
                            
                            // Add the QR code to the receipt
                            if (app.qr_code_image) {
                                const qrDiv = document.getElementById('generated-app-qr');
                                const img = document.createElement("img");
                                img.src = `data:image/png;base64,${app.qr_code_image}`;
                                img.alt = "QR Code for Generated App";
                                img.style.maxWidth = "150px";
                                img.style.margin = "0 auto";
                                img.style.display = "block";
                                qrDiv.appendChild(img);
                            }
                            
                            // Add the development logs if available
                            if (app.logs) {
                                const logElement = document.getElementById(`app-logs-${app.timestamp}`);
                                if (logElement) {
                                    logElement.textContent = app.logs;
                                }
                            }
                            
                            // Play a printer sound effect if available
                            try {
                                const audio = new Audio('/static/printer.mp3');
                                audio.play().catch(e => console.log('Sound not available'));
                            } catch (e) {
                                // Sound not critical, just continue silently
                            }
                        }
                        
                        // Also update the original manual results display for consistency
                        tabs[0].click();
                        
                        // Update the status with the generation message
                        statusDiv.textContent = `${app.message} GitHub: ${app.github_url}`;
                        
                        // Display QR code
                        qrCodeDiv.innerHTML = '';
                        if (app.qr_code_image) {
                           const img = document.createElement("img");
                           img.src = `data:image/png;base64,${app.qr_code_image}`;
                           img.alt = "QR Code for Generated App";
                           qrCodeDiv.appendChild(img);
                        }
                        
                        // Display URL
                        appUrlDiv.innerHTML = '';
                        if (app.hosted_url_full) {
                            const urlLink = document.createElement("a");
                            urlLink.href = app.hosted_url_full;
                            urlLink.textContent = app.hosted_url_full;
                            urlLink.target = "_blank";
                            appUrlDiv.appendChild(document.createTextNode("Access URL: "));
                            appUrlDiv.appendChild(urlLink);
                        }
                        
                        addLog(`App generated: ${app.app_type}`);
                        
                        // Switch back to the Venmo tab to show the receipt
                        setTimeout(() => {
                            tabs[1].click();
                        }, 2000);
                    }
                }
                
            } catch (error) {
                addLog(`Error checking email status: ${error.message}`, 'error');
                console.error("Error:", error);
            }
        }
        
        // Start periodic status updates
        function startStatusUpdates() {
            // Check status every 10 seconds
            setInterval(checkEmailStatus, 10000);
            
            // Also periodically check for new emails (every 30 seconds)
            setInterval(checkForNewEmails, 30000);
        }
        
        // Function to check for new emails
        async function checkForNewEmails() {
            try {
                const response = await fetch("/api/check-emails", {
                    method: "POST",
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    console.error("Failed to check emails:", result.error);
                    return;
                }
                
                if (result.payments_found > 0) {
                    addLog(`Found ${result.payments_found} new payment(s)!`);
                    // Refresh status immediately to see if we got any payments
                    checkEmailStatus();
                }
                
            } catch (error) {
                console.error("Error checking emails:", error);
            }
        }
        
        // Function to notify the server when QR code is scanned
        async function notifyQRScanned(event) {
            try {
                // If this was triggered from a link click, don't interfere with navigation
                if (event && event.type === 'click') {
                    // Don't prevent the link from working - let it open Venmo
                    // Just notify in the background
                    setTimeout(async () => {
                        await fetch('/api/venmo-scanned');
                    }, 0);
                } else {
                    // Direct click on QR code
                    const response = await fetch('/api/venmo-scanned');
                    const result = await response.json();
                    
                    // Open Venmo in a new window
                    window.open(document.querySelector('#venmo-qr-container a').href, '_blank');
                }
                
                addLog("QR code scanned - Venmo app opening...");
                
                // Show a message to encourage entering an app description
                const instructionsReceipt = document.getElementById('instructions-receipt');
                instructionsReceipt.style.border = '2px solid #2196F3';
                setTimeout(() => {
                    instructionsReceipt.style.border = '1px solid #ddd';
                }, 3000);
                
            } catch (error) {
                console.error('Error notifying scan:', error);
            }
        }
        
        // Add log message to the log area
        // Initialize the page and add default log message
        window.addEventListener('DOMContentLoaded', function() {
            // Initialize payment mode
            initPaymentMode();
            
            // Add initial log message
            if (emailLog && emailLog.childElementCount === 0) {
                addLog("System ready. Waiting for payments...");
            }
            
            // Check if the Venmo tab is already active
            const venmoTab = document.querySelector('.tab[data-tab="venmo"]');
            if (venmoTab && venmoTab.classList.contains('active')) {
                // Start email monitoring immediately
                setTimeout(startEmailMonitoring, 500);
            }
        });
        
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${level}`;
            logEntry.style.marginBottom = '3px';
            logEntry.style.padding = '2px 0';
            logEntry.style.borderBottom = '1px dotted #ccc';
            logEntry.style.opacity = '0'; // Start transparent for animation
            
            // Add log level indicator
            let levelMarker = '✓'; // Default for info
            let levelColor = '#000'; // Black text for most entries
            
            if (level === 'warning') {
                levelMarker = '!';
                levelColor = '#663c00';
            }
            if (level === 'error') {
                levelMarker = '✗';
                levelColor = '#9b0000';
            }
            
            logEntry.innerHTML = `<span style="color: #555; margin-right: 5px; font-family: monospace;">${timestamp}</span> <span style="color: ${levelColor}; margin-right: 5px;">${levelMarker}</span> ${message}`;
            
            // Add to log
            emailLog.appendChild(logEntry);
            
            // Animate printing effect
            setTimeout(() => {
                // Print sound effect
                const audio = document.createElement('audio');
                audio.src = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAAAwAAAbAAeHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHiZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZm0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAYBg//+1DEBvAAAd9AAcxwEGdlkAA3PVIAoCASCQ3UGmBYFgQCgMAYhgQdxhSGMLm4fBwMBgMBgMBgMBgMBgMBgMBgMBgMBgMBgMBgMBgMBgMBgMBg';
                audio.volume = 0.03; // Very quiet
                audio.play().catch(e => {});
                
                // Fade in with a printing effect
                let opacity = 0;
                const fadeIn = setInterval(() => {
                    opacity += 0.1;
                    logEntry.style.opacity = opacity;
                    if (opacity >= 1) {
                        clearInterval(fadeIn);
                    }
                }, 10);
            }, 10);
            
            // Auto-scroll to bottom with slight delay for animation
            setTimeout(() => {
                emailLog.scrollTop = emailLog.scrollHeight;
            }, 150);
        }
    </script>
</body>
</html>